# App Router：検索とページネーションの追加

**公開日:** 2025年11月18日

**原文:** https://nextjs.org/learn/dashboard-app/adding-search-and-pagination

---

## 第10章

### 導入

このチャプターでは、Next.js APIを使用して`/invoices`ページに検索とページネーション機能を実装する方法について説明します。前のストリーミング改善に基づき、URLパラメータではなくクライアント側の状態を通じて検索状態を管理する方法を学習します。

### キートピック

- **Next.jsクライアントフック：** `useSearchParams`、`usePathname`、`useRouter`
- **URLサーチパラメータ：** URLを通じて検索とページネーション状態を管理する
- **サーバー-クライアント統合：** コンポーネント間でのデータフェッチングの調整

### なぜURLサーチパラメータを使用するのか？

3つの主要な利点がこのアプローチを正当化します：

1. **ブックマーク可能で共有可能なURL：** ユーザーはサーチクエリやフィルターを含むアプリケーション状態をブックマークできます
2. **サーバー側レンダリング：** URLパラメータはサーバー側で直接消費され、初期状態のレンダリングを可能にします
3. **分析とトラッキング：** 追加のクライアントロジックなしで、検索クエリはURLに直接表示されるためユーザー行動の追跡が容易

### 実装ステップ

#### 1. ユーザー入力をキャプチャする

`<Search>`コンポーネント内に`handleSearch`関数を作成し、`onChange`リスナーで入力の変更に応答します。

#### 2. URLをサーチパラメータで更新する

`next/navigation`から`useSearchParams`をインポートします。`handleSearch`内で：
- 新しい`URLSearchParams`インスタンスを作成
- 入力に基づいて「query」パラメータを設定または削除
- `useRouter().replace()`を使用してページリロードなしでURLを更新

#### 3. URLと入力を同期に保つ

入力要素の`defaultValue={searchParams.get('query')?.toString()}`を使用して、URLの状態と同期を保つ。制御されていないコンポーネントパターンを活用します。

#### 4. Tableコンポーネントを更新する

ページからサーチパラメータをTableコンポーネントに渡し、サーバー側で`fetchFilteredInvoices()`を使用して結果をフィルターします。

### ベストプラクティス：デバウンス

デバウンスを実装して、過度なデータベースクエリを防ぎます。`use-debounce`ライブラリを使用：

```typescript
const handleSearch = useDebouncedCallback((term) => {
  // search logic
}, 300);
```

これは入力停止後300ms実行を遅延し、サーバーリクエストを大幅に削減します。

### ページネーションの実装

#### 総ページ数のフェッチング

`fetchInvoicesPages`をインポートして、サーチクエリに基づいて総ページ数を計算します。例えば、12の一致する請求書、1ページあたり6件で2総ページになります。

#### ページURLの作成

`<Pagination>`コンポーネントで`createPageURL`を実装：

```typescript
const createPageURL = (pageNumber: number | string) => {
  const params = new URLSearchParams(searchParams);
  params.set('page', pageNumber.toString());
  return `${pathname}?${params.toString()}`;
};
```

#### 検索時にページをリセットする

ユーザーが新しい検索クエリを入力するとき、`handleSearch`関数で`params.set('page', '1')`を設定してページ番号を1にリセットします。

### クライアント対サーバーの考慮

- **クライアントコンポーネント：** `useSearchParams()`フックを使用してサーバーラウンドトリップなしにパラメータにアクセス
- **サーバーコンポーネント：** ページコンポーネントから`searchParams`propを直接受け取る

ニーズに基づいて選択してください。クライアント側アクセスが必要な場合とサーバー側フェッチングに遅延できる場合です。

### 概要

完成した実装は以下を提供します：

- URLパラメータを使用した検索機能
- サーバー側データフェッチングと調整されたクライアント側入力
- `useRouter`を使用したスムーズなクライアント側ナビゲーション
- フィルタリング結果をサポートするページネーション
- データベース読み込みを削減するデバウンス最適化

このパターンは従来のクライアント状態管理とは異なりますが、SEO、共有可能性、分析統合に優れた利点を提供します。

---

**次のチャプター:** 第11章ではServer Actionsを使用したデータ変更について説明します。
